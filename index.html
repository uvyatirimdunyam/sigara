<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sigara Tasarruf HesaplayÄ±cÄ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8f9fa;
      padding: 0; /* Kenarlardaki boÅŸluklarÄ± kaldÄ±rmak iÃ§in padding 0 yapÄ±ldÄ± */
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      overflow-y: auto; /* Dikey kaydÄ±rmayÄ± etkinleÅŸtir */
      padding-bottom: 70px; /* SayfanÄ±n en altÄ±na boÅŸluk ekle */
    }
    .container {
      width: 100%; /* Mobil dahil tÃ¼m ekranlarda tam geniÅŸlik */
      padding-left: 0; /* Bootstrap'in varsayÄ±lan yatay padding'ini kaldÄ±r */
      padding-right: 0; /* Bootstrap'in varsayÄ±lan yatay padding'ini kaldÄ±r */
    }
    /* Orta ve daha bÃ¼yÃ¼k ekranlar iÃ§in maksimum geniÅŸlik ve yatay padding ekle */
    @media (min-width: 768px) { /* Bootstrap'in md (medium) breakpoint'i */
      .container {
        max-width: 600px; /* MasaÃ¼stÃ¼/tablet iÃ§in belirli bir maksimum geniÅŸlik */
        padding-left: var(--bs-gutter-x, 1.5rem); /* Bootstrap'in varsayÄ±lan yatay padding'ini geri ekle */
        padding-right: var(--bs-gutter-x, 1.5rem);
      }
    }
    .card {
      box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
      border-radius: 0; /* Mobil tam ekran iÃ§in kartÄ±n kÃ¶ÅŸelerini kaldÄ±rdÄ±m */
      padding: 1.5rem; /* Ä°Ã§erik iÃ§in yeterli boÅŸluk */
      margin: 0; /* Mobil cihazlarda kenar boÅŸluÄŸunu kaldÄ±r */
      border: none; /* Mobil cihazlarda kenarlÄ±ÄŸÄ± kaldÄ±r */
      margin-bottom: 20px; /* KartÄ±n altÄ±na boÅŸluk ekle */
    }
    /* Mobil cihazlarda kartÄ±n kenarlarÄ±nÄ± ekran kenarÄ±na yapÄ±ÅŸtÄ±rmak iÃ§in */
    @media (max-width: 767.98px) {
      .card {
        border-radius: 0; /* Mobil tam ekran iÃ§in kÃ¶ÅŸeleri tamamen dÃ¼z yap */
      }
    }

    .remove-btn {
      cursor: pointer;
    }
    .form-control-sm {
      font-size: 0.9rem;
    }
    .period-inputs .row {
      margin-bottom: 0.5rem;
    }
    .result-box {
      font-weight: bold;
      font-size: 1.2rem;
      margin-top: 1rem;
    }
    /* Ortak tablo stilleri */
    .period-savings-table {
        width: 100%; /* Tam geniÅŸliÄŸi kapla */
        border-collapse: collapse; /* GerÃ§ek tablolar iÃ§in */
        table-layout: fixed; /* SÃ¼tun geniÅŸliklerinin sabit kalmasÄ±nÄ± saÄŸlar */
    }
    .period-savings-table th {
        font-size: 0.95rem;
        padding: 0.5rem;
        background-color: #e9ecef;
        border-bottom: 2px solid #dee2e6;
        text-align: left; /* VarsayÄ±lan th hizalamasÄ± */
    }
    .period-savings-table th:last-child {
        text-align: right; /* Son baÅŸlÄ±ÄŸÄ± saÄŸa hizala (miktar/buton sÃ¼tunu iÃ§in) */
    }
    /* SÃ¼tun geniÅŸliklerini ayarla */
    .period-savings-table thead th:nth-child(1),
    .period-savings-table tbody td:nth-child(1) {
        width: 38%; /* 'DÃ¶nem BaÅŸlangÄ±cÄ±' iÃ§in geniÅŸlik */
    }
    .period-savings-table thead th:nth-child(2),
    .period-savings-table tbody td:nth-child(2) {
        width: 27%; /* 'Paket FiyatÄ±' iÃ§in geniÅŸlik */
    }
    .period-savings-table thead th:nth-child(3),
    .period-savings-table tbody td:nth-child(3) {
        width: 35%; /* 'Tasarruf (â‚º)' iÃ§in geniÅŸlik */
    }

    /* GerÃ§ek tasarruf tablosu iÃ§in stiller (tbody ve tfoot) */
    .period-savings-table tbody td {
        font-size: 0.9rem;
        color: #555;
        padding: 0.25rem 0.5rem;
        border-bottom: 1px solid #e9ecef;
    }
    .period-savings-table tbody tr:last-child td {
        border-bottom: none;
    }
    .period-savings-table tfoot td {
        font-weight: bold;
        padding-top: 0.75rem;
        border-top: 2px solid #dee2e6;
    }
    .period-savings-table td.text-end { /* td iÃ§in saÄŸa hizalama */
        text-align: right;
    }
    /* Toplam tasarruf satÄ±rÄ±nÄ±n ilk hÃ¼cresi iÃ§in geniÅŸlik */
    .period-savings-table tfoot td:nth-child(1) {
        width: 65%; /* Ä°lk iki sÃ¼tunun toplamÄ± (38% + 27%) */
    }
    .period-savings-table tfoot td:nth-child(2) {
        width: 35%; /* Son sÃ¼tunun geniÅŸliÄŸi */
    }


    /* Div tabanlÄ± geÃ§miÅŸ fiyatlar tablosu iÃ§in stiller */
    #pricePeriodsTable .row {
        display: flex;
        border-bottom: 1px solid #e9ecef;
        padding: 0.25rem 0;
        align-items: center;
    }
    #pricePeriodsTable .row:last-of-type {
        border-bottom: none;
    }
    #pricePeriodsTable .row > div { /* col-5 ve col-2 div'lerini hedefle */
        padding: 0.25rem 0.5rem; /* td padding'ini taklit et */
    }
    #pricePeriodsTable .row.fw-bold { /* BaÅŸlÄ±k satÄ±rÄ± stili */
        background-color: #e9ecef;
        border-bottom: 2px solid #dee2e6;
        padding: 0.5rem 0;
    }
    #pricePeriodsTable .row.fw-bold > div {
        padding: 0.5rem; /* th padding'iyle eÅŸleÅŸtir */
        font-weight: bold; /* BaÅŸlÄ±k metnini kalÄ±n yap */
    }
    #pricePeriodsTable .row.fw-bold .col-2 {
        text-align: right; /* Buton sÃ¼tunu baÅŸlÄ±ÄŸÄ±nÄ± hizala */
    }
    
    /* Tarih ve fiyat metinlerini input gibi hizalamak iÃ§in */
    .form-control-plaintext.form-control-sm {
        padding-top: calc(0.25rem + 1px);
        padding-bottom: calc(0.25rem + 1px);
        margin-bottom: 0;
        line-height: 1.5;
        border-bottom: 1px solid #dee2e6; /* Input benzeri gÃ¶rÃ¼nÃ¼m iÃ§in alt Ã§izgi */
    }
    /* Tarihsel dÃ¶nemler iÃ§in label'larÄ± gizle */
    .historical-period .form-label {
        display: none; /* Etiketleri gizle */
    }
    /* KullanÄ±cÄ± eklediÄŸi dÃ¶nemler iÃ§in label'larÄ± gizle */
    .period-inputs .col-5 label {
        display: none; /* Dinamik olarak eklenen dÃ¶nemlerin etiketlerini gizle */
    }
    /* Fiyat DÃ¶nemleri detaylarÄ±nÄ± baÅŸlangÄ±Ã§ta gizlemek iÃ§in */
    #historicalPeriodsContainer {
        display: none; /* BaÅŸlangÄ±Ã§ta gizli */
    }
    /* DetaylÄ± tasarruf div'i iÃ§in yatay kaydÄ±rma */
    #detailedSavings {
        overflow-x: auto; /* Ä°Ã§erik taÅŸarsa yatay kaydÄ±rma Ã§ubuÄŸu gÃ¶ster */
        -webkit-overflow-scrolling: touch; /* iOS'ta daha akÄ±cÄ± kaydÄ±rma */
    }
    /* Grafik konteyneri iÃ§in stil */
    #savingsChartContainer {
        margin-top: 2rem;
        background-color: #fff;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.05);
        display: none; /* BaÅŸlangÄ±Ã§ta gizli */
        height: 250px; /* GrafiÄŸin sabit yÃ¼ksekliÄŸi */
        position: relative; /* Canvas'Ä±n %100 yÃ¼ksekliÄŸini almasÄ± iÃ§in */
    }
    #savingsChart {
        width: 100%; /* Konteynerin geniÅŸliÄŸini kapla */
        height: 100%; /* Konteynerin yÃ¼ksekliÄŸini kapla */
    }

    /* Yeni eklenen hedefler ve istatistikler bÃ¶lÃ¼mleri iÃ§in stil */
    .goals-section, .stats-section, .investment-section {
        margin-top: 2rem;
        background-color: #fff;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.05);
        /* display: none; */ /* Bu satÄ±rÄ± kaldÄ±rdÄ±k, artÄ±k varsayÄ±lan olarak gÃ¶rÃ¼nÃ¼r */
    }
    .goal-item {
        margin-bottom: 1rem;
    }
    .goal-item:last-child {
        margin-bottom: 0;
    }
    .progress {
        height: 20px; /* Progress bar yÃ¼ksekliÄŸi */
        font-size: 0.85rem;
    }
    .progress-bar {
        background-color: #28a745; /* YeÅŸil renk */
    }
    .stats-item {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
    }
    /* KÃ¢r/Zarar durumu iÃ§in renkler */
    .profit {
        color: #28a745; /* YeÅŸil */
        font-weight: bold;
    }
    .loss {
        color: #dc3545; /* KÄ±rmÄ±zÄ± */
        font-weight: bold;
    }
    .neutral {
        color: #6c757d; /* Gri */
        font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card p-4">
      <h2 class="mb-4 text-center">ðŸš­ Sigara Tasarruf HesaplayÄ±cÄ±</h2>
      <form id="savingsForm">
        <div class="mb-3 row justify-content-center">
          <div class="col-md-5">
            <label for="dailyCigarettes" class="form-label">GÃ¼nlÃ¼k Sigara Adedi</label>
            <input type="number" class="form-control" id="dailyCigarettes" required>
          </div>
          <div class="col-md-5">
            <label for="startDate" class="form-label">BÄ±rakma Tarihi</label>
            <input type="date" class="form-control" id="startDate" required>
          </div>
        </div>

        <div class="d-flex align-items-center mt-4">
            <h5 class="mb-0">ðŸ“… Fiyat DÃ¶nemleri</h5>
            <button type="button" class="btn btn-sm btn-outline-info ms-auto" id="toggleHistoricalPeriodsBtn">GeÃ§miÅŸ FiyatlarÄ± GÃ¶ster</button>
        </div>
        
        <div id="historicalPeriodsContainer"> <!-- GeÃ§miÅŸ fiyatlarÄ±n kapsayÄ±cÄ±sÄ± -->
            <p class="text-muted small mb-3 mt-2">
              GeÃ§miÅŸ fiyat verileri piyasadaki ortalama en ucuz sigara paket fiyatlarÄ±na gÃ¶re eklenmiÅŸtir ve deÄŸiÅŸtirilemez.
              Yeni dÃ¶nemler ekleyerek kendi verilerinizi girebilirsiniz.
            </p>
            
            <div id="pricePeriodsTable" class="mb-3 period-savings-table"> <!-- Yeni konteyner: BaÅŸlÄ±k ve dÃ¶nemleri iÃ§erir -->
                <div class="row fw-bold"> <!-- BaÅŸlÄ±k satÄ±rÄ± -->
                    <div class="col-5">BaÅŸlangÄ±Ã§ Tarihi</div>
                    <div class="col-5">Paket FiyatÄ± (â‚º)</div>
                    <div class="col-2 text-end"></div> <!-- KaldÄ±r butonu sÃ¼tunu iÃ§in boÅŸluk -->
                </div>
                <div id="pricePeriods" class="period-inputs"></div> <!-- DÃ¶nemlerin ekleneceÄŸi yer -->
            </div>
        </div>

        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addPeriod()">+ DÃ¶nem Ekle</button>

        <div class="result-box text-success" id="result"></div>

        <h5 class="mt-3">DÃ¶nemlere GÃ¶re Tasarruf DetaylarÄ±:</h5>
        <div id="detailedSavings" class="mt-2"></div>

        <div id="savingsChartContainer">
            <h5 class="mb-3">Tasarruf GrafiÄŸi</h5>
            <canvas id="savingsChart"></canvas>
        </div>

        <!-- Yeni eklenen SigarasÄ±z GeÃ§en SÃ¼re Hedefleri bÃ¶lÃ¼mÃ¼ -->
        <div id="smokeFreeGoals" class="goals-section">
            <h5 class="mb-3">SigarasÄ±z GeÃ§en SÃ¼re Hedefleri</h5>
            <div id="goalsList">
                <!-- Hedefler buraya JavaScript ile eklenecek -->
            </div>
        </div>

        <!-- Yeni eklenen Ä°Ã§ilmeyen Sigara ve Paket SayÄ±sÄ± bÃ¶lÃ¼mÃ¼ -->
        <div id="smokeFreeStats" class="stats-section">
            <h5 class="mb-3">Ä°Ã§ilmeyen Sigara ve Paket SayÄ±sÄ±</h5>
            <p id="totalCigarettesNotSmoked" class="stats-item"></p>
            <p id="totalPacksNotSmoked" class="stats-item"></p>
        </div>

        <!-- Yeni eklenen YatÄ±rÄ±m Takibi bÃ¶lÃ¼mÃ¼ -->
        <div id="investmentTracker" class="investment-section">
            <h5 class="mb-3">YatÄ±rÄ±m Takibi</h5>
            <div class="mb-3 row">
                <div class="col-md-6">
                    <label for="investedAmount" class="form-label">YatÄ±rÄ±lan Tutar (â‚º)</label>
                    <input type="number" class="form-control" id="investedAmount" step="0.01">
                </div>
                <div class="col-md-6">
                    <label for="currentValue" class="form-label">Åžu Anki DeÄŸer (â‚º)</label>
                    <input type="number" class="form-control" id="currentValue" step="0.01">
                </div>
            </div>
            <p id="investmentStatus" class="stats-item text-center"></p>
        </div>

      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const pricePeriods = document.getElementById("pricePeriods");
    const startDateInput = document.getElementById("startDate");
    const resultDiv = document.getElementById("result");
    const detailedSavingsDiv = document.getElementById("detailedSavings");
    const historicalPeriodsContainer = document.getElementById("historicalPeriodsContainer");
    const toggleHistoricalPeriodsBtn = document.getElementById("toggleHistoricalPeriodsBtn");
    const savingsChartCanvas = document.getElementById('savingsChart');
    const savingsChartContainer = document.getElementById('savingsChartContainer');
    const smokeFreeGoalsDiv = document.getElementById('smokeFreeGoals');
    const goalsListDiv = document.getElementById('goalsList');
    const smokeFreeStatsDiv = document.getElementById('smokeFreeStats');
    const totalCigarettesNotSmokedP = document.getElementById('totalCigarettesNotSmoked');
    const totalPacksNotSmokedP = document.getElementById('totalPacksNotSmoked');
    const investmentTrackerDiv = document.getElementById('investmentTracker');
    const investedAmountInput = document.getElementById('investedAmount');
    const currentValueInput = document.getElementById('currentValue');
    const investmentStatusP = document.getElementById('investmentStatus');


    let savingsChartInstance = null; // Chart.js Ã¶rneÄŸini tutacak deÄŸiÅŸken

    const LOCAL_STORAGE_KEY = 'cigaretteSavingsData';

    /**
     * YYYY-MM-DD formatÄ±ndaki bir tarih dizesini gg.aa.yyyy formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
     * @param {string} dateString - YYYY-MM-DD formatÄ±nda tarih dizesi.
     * @returns {string} gg.aa.yyyy formatÄ±nda tarih dizesi.
     */
    function formatDateToDDMMYYYY(dateString) {
        if (!dateString) return '';
        const [year, month, day] = dateString.split('-');
        return `${day}.${month}.${year}`;
    }

    /**
     * gg.aa.yyyy formatÄ±ndaki bir tarih dizesini YYYY-MM-DD formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
     * @param {string} dateString - gg.aa.yyyy formatÄ±nda tarih dizesi.
     * @returns {string} YYYY-MM-DD formatÄ±nda tarih dizesi.
     */
    function parseDateFromDDMMYYYY(dateString) {
        if (!dateString) return '';
        const parts = dateString.split('.');
        if (parts.length === 3) {
            return `${parts[2]}-${parts[1]}-${parts[0]}`; // YYYY-MM-DD
        }
        return ''; // GeÃ§ersiz format
    }

    /**
     * Yeni bir fiyat dÃ¶nemi giriÅŸ alanÄ± ekler.
     * @param {string} date - DÃ¶nemin baÅŸlangÄ±Ã§ tarihi (YYYY-MM-DD formatÄ±nda).
     * @param {number} price - Paket fiyatÄ±.
     * @param {boolean} fromLoad - Verinin localStorage'dan mÄ± yÃ¼klendiÄŸini belirtir.
     * @param {boolean} isHistorical - DÃ¶nemin sabit geÃ§miÅŸ veri olup olmadÄ±ÄŸÄ±nÄ± belirtir.
     */
    function addPeriod(date = '', price = '', fromLoad = false, isHistorical = false) {
      const row = document.createElement("div");
      row.classList.add("row", "align-items-end");
      
      const displayDate = formatDateToDDMMYYYY(date); // Tarihi gg.aa.yyyy formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼r

      if (isHistorical) {
          row.classList.add("historical-period"); // Tarihsel dÃ¶nemleri iÅŸaretlemek iÃ§in sÄ±nÄ±f
          row.innerHTML = `
            <div class="col-5">
              <p class="form-control-plaintext form-control-sm">${displayDate}</p>
            </div>
            <div class="col-5">
              <p class="form-control-plaintext form-control-sm">${price.toFixed(2)} â‚º</p>
            </div>
            <div class="col-2 text-end">
              <!-- Tarihsel veriler iÃ§in kaldÄ±r butonu yok -->
            </div>
          `;
      } else {
          row.innerHTML = `
            <div class="col-5">
              <input type="date" class="form-control form-control-sm period-date" value="${date}">
            </div>
            <div class="col-5">
              <input type="number" class="form-control form-control-sm period-price" step="0.01" value="${price}">
            </div>
            <div class="col-2 text-end">
              <button type="button" class="btn btn-sm btn-outline-danger remove-btn" onclick="removePeriod(this)">KaldÄ±r</button>
            </div>
          `;
      }
      pricePeriods.appendChild(row);
      if (!fromLoad) {
        calculateSavings(); 
      }
    }

    /**
     * Bir fiyat dÃ¶nemi giriÅŸ alanÄ±nÄ± kaldÄ±rÄ±r.
     * @param {HTMLElement} button - KaldÄ±r dÃ¼ÄŸmesi.
     */
    function removePeriod(button) {
      button.closest(".row").remove();
      calculateSavings();
    }

    /**
     * Mevcut verileri localStorage'a kaydeder.
     */
    function saveData() {
        const dailyCigarettes = document.getElementById("dailyCigarettes").value;
        const startDate = startDateInput.value;
        const periods = Array.from(pricePeriods.children)
            .filter(row => !row.classList.contains("historical-period"))
            .map(row => {
                const date = row.querySelector(".period-date").value;
                const price = row.querySelector(".period-price").value;
                return { date, price };
            });
        
        const investedAmount = investedAmountInput.value;
        const currentValue = currentValueInput.value;

        const dataToSave = {
            dailyCigarettes: dailyCigarettes,
            startDate: startDate,
            periods: periods,
            investedAmount: investedAmount,
            currentValue: currentValue
        };
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
    }

    /**
     * localStorage'dan verileri yÃ¼kler.
     */
    function loadData() {
        while (pricePeriods.firstChild) {
            pricePeriods.removeChild(pricePeriods.firstChild);
        }
        
        addDefaultHistoricalPeriods();

        const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (savedData) {
            const data = JSON.parse(savedData);
            document.getElementById("dailyCigarettes").value = data.dailyCigarettes || '';
            startDateInput.value = data.startDate || '';

            if (data.periods && data.periods.length > 0) {
                data.periods.forEach(p => addPeriod(p.date, p.price, true, false));
            }
            investedAmountInput.value = data.investedAmount || '';
            currentValueInput.value = data.currentValue || '';

        } else {
            document.getElementById("dailyCigarettes").value = '';
            startDateInput.value = '';
            investedAmountInput.value = '';
            currentValueInput.value = '';
        }

        calculateSavings();
    }

    /**
     * VarsayÄ±lan geÃ§miÅŸ sigara fiyat dÃ¶nemlerini ekler.
     */
    function addDefaultHistoricalPeriods() {
        addPeriod('2019-01-01', 11.00, true, true); 
        addPeriod('2020-01-01', 16.00, true, true);
        addPeriod('2021-01-01', 16.00, true, true);
        addPeriod('2022-01-01', 23.00, true, true);
        addPeriod('2022-04-01', 25.00, true, true);
        addPeriod('2023-01-01', 34.00, true, true);
        addPeriod('2023-07-01', 45.00, true, true);
        addPeriod('2023-09-05', 51.00, true, true);
        addPeriod('2024-01-01', 56.00, true, true);
        addPeriod('2024-07-01', 70.00, true, true);
        addPeriod('2024-10-01', 81.00, true, true);
        addPeriod('2025-03-01', 76.00, true, true);
        addPeriod('2025-07-01', 91.00, true, true);
    }

    /**
     * GrafiÄŸi gÃ¼nceller veya oluÅŸturur.
     * @param {Object} chartData - Grafik iÃ§in kullanÄ±lacak veri (etiketler ve veri noktalarÄ±).
     */
    function updateChart(chartData) {
        if (!savingsChartCanvas || !savingsChartContainer) {
            console.error("Grafik canvas veya konteyner elementi bulunamadÄ±.");
            return;
        }

        if (!chartData || chartData.labels.length === 0) {
            savingsChartContainer.style.display = 'none';
            if (savingsChartInstance) {
                savingsChartInstance.destroy();
                savingsChartInstance = null;
            }
            return;
        }

        savingsChartContainer.style.display = 'block';

        const ctx = savingsChartCanvas.getContext('2d');

        if (savingsChartInstance) {
            savingsChartInstance.data.labels = chartData.labels;
            savingsChartInstance.data.datasets[0].data = chartData.data;
            savingsChartInstance.update();
        } else {
            savingsChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'KÃ¼mÃ¼latif Tasarruf (â‚º)',
                        data: chartData.data,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Tasarruf (â‚º)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Tarih'
                            },
                            ticks: {
                                autoSkip: true,
                                maxRotation: 45,
                                minRotation: 0,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' â‚º';
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    /**
     * SigarasÄ±z geÃ§en sÃ¼re hedeflerini ve ilerleme Ã§ubuklarÄ±nÄ± gÃ¼nceller.
     * @param {number} daysNotSmoked - SigarasÄ±z geÃ§en toplam gÃ¼n sayÄ±sÄ±.
     */
    function updateSmokeFreeGoals(daysNotSmoked) {
        if (!smokeFreeGoalsDiv || !goalsListDiv) {
            console.error("Smoke-free goals div or goals list div not found.");
            return;
        }

        if (daysNotSmoked <= 0) {
            smokeFreeGoalsDiv.style.display = 'none';
            goalsListDiv.innerHTML = '';
            return;
        }

        smokeFreeGoalsDiv.style.display = 'block';
        goalsListDiv.innerHTML = ''; // Ã–nceki hedefleri temizle

        const goals = [
            { name: "1 Hafta", days: 7 },
            { name: "1 Ay", days: 30 }, // Ortalama 30 gÃ¼n
            { name: "3 Ay", days: 90 },
            { name: "6 Ay", days: 180 },
            { name: "1 YÄ±l", days: 365 },
            { name: "2 YÄ±l", days: 365 * 2 },
            { name: "3 YÄ±l", days: 365 * 3 },
            { name: "5 YÄ±l", days: 365 * 5 },
            { name: "10 YÄ±l", days: 365 * 10 }
        ];

        goals.forEach(goal => {
            const percentage = Math.min(100, (daysNotSmoked / goal.days) * 100);
            let progressText = '';
            let progressBarClass = 'bg-success'; // VarsayÄ±lan yeÅŸil

            if (percentage >= 100) {
                progressText = 'TamamlandÄ±!';
            } else {
                const remainingDays = goal.days - daysNotSmoked;
                if (remainingDays > 0) {
                    progressText = `${percentage.toFixed(0)}% tamamlandÄ±`;
                    // Ä°steÄŸe baÄŸlÄ± olarak farklÄ± renkler eklenebilir
                    if (percentage < 25) progressBarClass = 'bg-danger';
                    else if (percentage < 75) progressBarClass = 'bg-warning';
                } else {
                    progressText = 'TamamlandÄ±!'; // Negatif gÃ¼n kalma durumu olmamasÄ± iÃ§in
                }
            }

            const goalItem = document.createElement('div');
            goalItem.classList.add('goal-item');
            goalItem.innerHTML = `
                <p class="mb-1">${goal.name} SigarasÄ±z</p>
                <div class="progress">
                    <div class="progress-bar ${progressBarClass}" role="progressbar" style="width: ${percentage}%" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">${progressText}</div>
                </div>
            `;
            goalsListDiv.appendChild(goalItem);
        });
    }

    /**
     * Ä°Ã§ilmeyen sigara ve paket sayÄ±larÄ±nÄ± gÃ¼nceller.
     * @param {number} dailyCigarettes - GÃ¼nlÃ¼k iÃ§ilen sigara adedi.
     * @param {number} daysNotSmoked - SigarasÄ±z geÃ§en toplam gÃ¼n sayÄ±sÄ±.
     */
    function updateSmokeFreeStats(dailyCigarettes, daysNotSmoked) {
        if (!smokeFreeStatsDiv || !totalCigarettesNotSmokedP || !totalPacksNotSmokedP) {
            console.error("Smoke-free stats elements not found.");
            return;
        }

        if (daysNotSmoked <= 0 || dailyCigarettes <= 0) {
            smokeFreeStatsDiv.style.display = 'none';
            totalCigarettesNotSmokedP.innerHTML = '';
            totalPacksNotSmokedP.innerHTML = '';
            return;
        }

        smokeFreeStatsDiv.style.display = 'block';

        const totalCigarettesNotSmoked = dailyCigarettes * daysNotSmoked;
        const totalPacksNotSmoked = totalCigarettesNotSmoked / 20;

        totalCigarettesNotSmokedP.innerHTML = `ðŸš­ Ä°Ã§ilmeyen Toplam Sigara Adedi: <strong>${totalCigarettesNotSmoked.toLocaleString('tr-TR')} adet</strong>`;
        totalPacksNotSmokedP.innerHTML = `ðŸ“¦ Ä°Ã§ilmeyen Toplam Paket SayÄ±sÄ±: <strong>${totalPacksNotSmoked.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} paket</strong>`;
    }

    /**
     * YatÄ±rÄ±m durumunu hesaplar ve gÃ¼nceller.
     */
    function updateInvestmentStatus() {
        if (!investmentTrackerDiv || !investedAmountInput || !currentValueInput || !investmentStatusP) {
            console.error("Investment tracker elements not found.");
            return;
        }

        const investedAmount = parseFloat(investedAmountInput.value);
        const currentValue = parseFloat(currentValueInput.value);

        // EÄŸer her iki alan da boÅŸsa veya geÃ§ersizse, durumu temizle
        if (isNaN(investedAmount) && isNaN(currentValue)) {
            investmentStatusP.innerHTML = 'YatÄ±rÄ±m tutarÄ± ve ÅŸu anki deÄŸeri giriniz.';
            investmentStatusP.className = 'stats-item text-center neutral';
            return;
        }
        
        // EÄŸer sadece biri geÃ§erliyse veya ikisi de sayÄ±sal ama negatifse
        if (isNaN(investedAmount) || isNaN(currentValue) || investedAmount < 0 || currentValue < 0) {
            investmentStatusP.innerHTML = 'GeÃ§erli sayÄ±sal deÄŸerler giriniz.';
            investmentStatusP.className = 'stats-item text-center neutral';
            return;
        }

        const profitLoss = currentValue - investedAmount;
        let percentageChange = 0;
        let statusText = '';
        let statusClass = '';

        if (investedAmount === 0) {
            if (currentValue > 0) {
                statusText = `YatÄ±rÄ±mÄ±nÄ±zÄ±n deÄŸeri: ${currentValue.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚º (YatÄ±rÄ±m tutarÄ± sÄ±fÄ±r)`;
                statusClass = 'neutral';
            } else {
                statusText = 'YatÄ±rÄ±m tutarÄ± ve deÄŸeri giriniz.';
                statusClass = 'neutral';
            }
        } else {
            percentageChange = (profitLoss / investedAmount) * 100;

            if (profitLoss > 0) {
                statusText = `ðŸ“ˆ KÃ¢r: ${profitLoss.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚º (%${percentageChange.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})`;
                statusClass = 'profit';
            } else if (profitLoss < 0) {
                statusText = `ðŸ“‰ Zarar: ${Math.abs(profitLoss).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚º (%${percentageChange.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})`;
                statusClass = 'loss';
            } else {
                statusText = `â†”ï¸ Ne KÃ¢r Ne Zarar: ${profitLoss.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚º (%${percentageChange.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})`;
                statusClass = 'neutral';
            }
        }
        
        investmentStatusP.innerHTML = statusText;
        investmentStatusP.className = `stats-item text-center ${statusClass}`; // SÄ±nÄ±fÄ± gÃ¼ncelle
    }


    /**
     * Sigara tasarrufunu hesaplar ve sonuÃ§larÄ± gÃ¼nceller.
     */
    function calculateSavings() {
      const dailyCigarettes = parseFloat(document.getElementById("dailyCigarettes").value);
      const quitDate = new Date(startDateInput.value);
      quitDate.setHours(0, 0, 0, 0);

      const now = new Date();
      now.setHours(0, 0, 0, 0);

      const timeDiff = now.getTime() - quitDate.getTime();
      const daysNotSmoked = Math.max(0, Math.floor(timeDiff / (1000 * 3600 * 24))); // SigarasÄ±z geÃ§en gÃ¼n sayÄ±sÄ±

      // GeÃ§ersiz giriÅŸler veya ileri tarih kontrolÃ¼
      if (!startDateInput.value || isNaN(dailyCigarettes) || dailyCigarettes <= 0 || now < quitDate) {
        if (resultDiv) resultDiv.innerHTML = '';
        if (detailedSavingsDiv) detailedSavingsDiv.innerHTML = '';
        updateChart(null);
        updateSmokeFreeGoals(0); // Hedefleri temizle
        updateSmokeFreeStats(0, 0); // Ä°statistikleri temizle
        updateInvestmentStatus(); // YatÄ±rÄ±m takibini temizle/gizle (sadece durumu temizler, inputlarÄ± deÄŸil)
        saveData();
        return;
      }

      const periods = Array.from(pricePeriods.children).map(row => {
        let date, price;
        if (row.classList.contains("historical-period")) {
            const dateP = row.querySelector(".col-5:nth-child(1) p");
            const priceP = row.querySelector(".col-5:nth-child(2) p");
            if (dateP && priceP) {
                const parsedDateString = parseDateFromDDMMYYYY(dateP.textContent);
                date = new Date(parsedDateString);
                price = parseFloat(priceP.textContent.replace(' â‚º', '')); 
            } else {
                console.error("Tarihsel dÃ¶nem satÄ±rÄ±nda beklenen <p> elementleri eksik:", row);
                return { date: new Date('Invalid Date'), price: 0 };
            }
        } else {
            const dateInput = row.querySelector(".period-date");
            const priceInput = row.querySelector(".period-price");
            if (dateInput && priceInput) {
                date = new Date(dateInput.value);
                price = parseFloat(priceInput.value);
            } else {
                console.error("KullanÄ±cÄ± tarafÄ±ndan eklenen dÃ¶nem satÄ±rÄ±nda beklenen input elementleri eksik:", row);
                return { date: new Date('Invalid Date'), price: 0 };
            }
        }
        date.setHours(0, 0, 0, 0);
        return { date, price };
      }).filter(p => !isNaN(p.date.getTime()) && !isNaN(p.price) && p.price > 0);

      if (periods.length === 0) {
        if (resultDiv) resultDiv.innerHTML = 'En az bir geÃ§erli fiyat dÃ¶nemi ekleyiniz.';
        if (detailedSavingsDiv) detailedSavingsDiv.innerHTML = '';
        updateChart(null);
        updateSmokeFreeGoals(0); // Hedefleri temizle
        updateSmokeFreeStats(0, 0); // Ä°statistikleri temizle
        updateInvestmentStatus(); // YatÄ±rÄ±m takibini temizle/gizle
        saveData();
        return;
      }

      periods.sort((a, b) => a.date.getTime() - b.date.getTime());

      let totalSavings = 0;
      let periodAccumulatedSavings = {};
      let chartLabels = [];
      let chartDataPoints = [];
      let cumulativeSavingsForChart = 0;

      let currentDate = new Date(quitDate);

      while (currentDate <= now) {
        let applicablePrice = 0;
        let currentPeriodStartDate = null;

        for (let i = 0; i < periods.length; i++) {
          if (currentDate >= periods[i].date) {
            applicablePrice = periods[i].price;
            currentPeriodStartDate = periods[i].date;
          } else {
            break;
          }
        }

        if (applicablePrice > 0) {
            const dailyCost = (dailyCigarettes / 20) * applicablePrice;
            totalSavings += dailyCost;
            cumulativeSavingsForChart += dailyCost;

            const periodKey = currentPeriodStartDate.toISOString().split('T')[0];
            if (!periodAccumulatedSavings[periodKey]) {
                periodAccumulatedSavings[periodKey] = {
                    amount: 0,
                    price: applicablePrice,
                    startDate: currentPeriodStartDate
                };
            }
            periodAccumulatedSavings[periodKey].amount += dailyCost;

            chartLabels.push(formatDateToDDMMYYYY(currentDate.toISOString().split('T')[0]));
            chartDataPoints.push(cumulativeSavingsForChart);
        }

        currentDate.setDate(currentDate.getDate() + 1);
      }

      let tableHtml = `
        <table class="table table-sm period-savings-table">
            <thead>
                <tr>
                    <th>DÃ¶nem BaÅŸlangÄ±cÄ±</th>
                    <th>Paket FiyatÄ±</th>
                    <th class="text-end">Tasarruf (â‚º)</th>
                </tr>
            </thead>
            <tbody>
      `;
      
      const sortedPeriodKeys = Object.keys(periodAccumulatedSavings).sort();

      for (const key of sortedPeriodKeys) {
          const periodData = periodAccumulatedSavings[key];
          const periodStartDate = new Date(key);
          
          tableHtml += `
              <tr>
                  <td>${formatDateToDDMMYYYY(periodStartDate.toISOString().split('T')[0])}</td>
                  <td>${periodData.price.toFixed(2)} â‚º</td>
                  <td class="text-end">${periodData.amount.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚º</td>
              </tr>
          `;
      }

      tableHtml += `
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="2">Toplam Tasarruf</td>
                    <td class="text-end">${totalSavings.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚º</td>
                </tr>
            </tfoot>
        </table>
      `;

      if (resultDiv) resultDiv.innerHTML = `ðŸ’° Tahmini Toplam Tasarruf: <span class="text-dark">${totalSavings.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚º</span>`;
      if (detailedSavingsDiv) detailedSavingsDiv.innerHTML = tableHtml;
      
      updateChart({ labels: chartLabels, data: chartDataPoints });
      updateSmokeFreeGoals(daysNotSmoked);
      updateSmokeFreeStats(dailyCigarettes, daysNotSmoked);
      updateInvestmentStatus(); // YatÄ±rÄ±m takibini gÃ¼ncelle

      saveData();
    }

    // GeÃ§miÅŸ fiyatlarÄ± gÃ¶ster/gizle dÃ¼ÄŸmesi iÅŸlevi
    toggleHistoricalPeriodsBtn.addEventListener('click', () => {
        if (historicalPeriodsContainer.style.display === 'none' || historicalPeriodsContainer.style.display === '') {
            historicalPeriodsContainer.style.display = 'block';
            toggleHistoricalPeriodsBtn.textContent = 'GeÃ§miÅŸ FiyatlarÄ± Gizle';
        } else {
            historicalPeriodsContainer.style.display = 'none';
            toggleHistoricalPeriodsBtn.textContent = 'GeÃ§miÅŸ FiyatlarÄ± GÃ¶ster';
        }
    });

    // YatÄ±rÄ±m takibi input'larÄ±na olay dinleyicileri ekle
    investedAmountInput.addEventListener('input', updateInvestmentStatus);
    currentValueInput.addEventListener('input', updateInvestmentStatus);

    document.getElementById("savingsForm").addEventListener("input", calculateSavings);

    document.addEventListener("DOMContentLoaded", () => {
      loadData();
    });
  </script>
</body>
</html>
