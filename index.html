<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sigara Tasarruf HesaplayÄ±cÄ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8f9fa;
      padding: 2rem;
      display: flex; /* Ä°Ã§eriÄŸi dikeyde ve yatayda ortalamak iÃ§in */
      justify-content: center; /* Yatayda ortala */
      align-items: flex-start; /* Dikeyde baÅŸlangÄ±ca hizala, gerekirse ortala */
      min-height: 100vh; /* SayfanÄ±n tÃ¼m yÃ¼ksekliÄŸini kapla */
    }
    .container {
      max-width: 600px; /* Konteynerin maksimum geniÅŸliÄŸini ayarla */
      width: 100%; /* DuyarlÄ±lÄ±k iÃ§in geniÅŸliÄŸi %100 yap */
    }
    .card {
      box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
    }
    .remove-btn {
      cursor: pointer;
    }
    .form-control-sm {
      font-size: 0.9rem;
    }
    .period-inputs .row {
      margin-bottom: 0.5rem;
    }
    .result-box {
      font-weight: bold;
      font-size: 1.2rem;
      margin-top: 1rem;
    }
    .period-savings-detail {
      font-size: 0.9rem;
      color: #555;
      margin-top: 0.5rem;
    }
    /* Tarih ve fiyat metinlerini input gibi hizalamak iÃ§in */
    .form-control-plaintext.form-control-sm {
        padding-top: calc(0.25rem + 1px);
        padding-bottom: calc(0.25rem + 1px);
        margin-bottom: 0;
        line-height: 1.5;
        border-bottom: 1px solid #dee2e6; /* Alt Ã§izgi ekleyelim */
    }
    .historical-period .form-label {
        color: #6c757d; /* Etiket rengini hafifletelim */
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card p-4">
      <h2 class="mb-4 text-center">ğŸš­ Sigara Tasarruf HesaplayÄ±cÄ±</h2>
      <form id="savingsForm">
        <div class="mb-3 row justify-content-center">
          <div class="col-md-5">
            <label for="dailyCigarettes" class="form-label">GÃ¼nlÃ¼k Sigara Adedi</label>
            <input type="number" class="form-control" id="dailyCigarettes" value="20" required>
          </div>
          <div class="col-md-5">
            <label for="startDate" class="form-label">BÄ±rakma Tarihi</label>
            <input type="date" class="form-control" id="startDate" required>
          </div>
        </div>

        <h5 class="mt-4">ğŸ“… Fiyat DÃ¶nemleri</h5>
        <p class="text-muted small mb-3">
          GeÃ§miÅŸ fiyat verileri piyasadaki ortalama en ucuz sigara paket fiyatlarÄ±na gÃ¶re eklenmiÅŸtir ve deÄŸiÅŸtirilemez.
          Yeni dÃ¶nemler ekleyerek kendi verilerinizi girebilirsiniz.
        </p>
        <div id="pricePeriods" class="period-inputs"></div>

        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addPeriod()">+ DÃ¶nem Ekle</button>

        <div class="result-box text-success" id="result"></div>
        <div id="detailedSavings" class="mt-3"></div>
      </form>
    </div>
  </div>

  <script>
    const pricePeriods = document.getElementById("pricePeriods");
    const startDateInput = document.getElementById("startDate");
    const resultDiv = document.getElementById("result");
    const detailedSavingsDiv = document.getElementById("detailedSavings");

    const LOCAL_STORAGE_KEY = 'cigaretteSavingsData';

    /**
     * Yeni bir fiyat dÃ¶nemi giriÅŸ alanÄ± ekler.
     * @param {string} date - DÃ¶nemin baÅŸlangÄ±Ã§ tarihi (YYYY-MM-DD formatÄ±nda).
     * @param {number} price - Paket fiyatÄ±.
     * @param {boolean} fromLoad - Verinin localStorage'dan mÄ± yÃ¼klendiÄŸini belirtir.
     * @param {boolean} isHistorical - DÃ¶nemin sabit geÃ§miÅŸ veri olup olmadÄ±ÄŸÄ±nÄ± belirtir.
     */
    function addPeriod(date = '', price = '', fromLoad = false, isHistorical = false) {
      const row = document.createElement("div");
      row.classList.add("row", "align-items-end");
      
      if (isHistorical) {
          row.classList.add("historical-period"); // Tarihsel dÃ¶nemleri iÅŸaretlemek iÃ§in sÄ±nÄ±f
          row.innerHTML = `
            <div class="col-md-5">
              <label class="form-label">BaÅŸlangÄ±Ã§ Tarihi</label>
              <p class="form-control-plaintext form-control-sm">${date}</p>
            </div>
            <div class="col-md-5">
              <label class="form-label">Paket FiyatÄ± (â‚º)</label>
              <p class="form-control-plaintext form-control-sm">${price.toFixed(2)}</p>
            </div>
            <div class="col-md-2 text-end">
              <!-- Tarihsel veriler iÃ§in kaldÄ±r butonu yok -->
            </div>
          `;
      } else {
          row.innerHTML = `
            <div class="col-md-5">
              <label class="form-label">BaÅŸlangÄ±Ã§ Tarihi</label>
              <input type="date" class="form-control form-control-sm period-date" value="${date}">
            </div>
            <div class="col-md-5">
              <label class="form-label">Paket FiyatÄ± (â‚º)</label>
              <input type="number" class="form-control form-control-sm period-price" step="0.01" value="${price}">
            </div>
            <div class="col-md-2 text-end">
              <button type="button" class="btn btn-sm btn-outline-danger remove-btn" onclick="removePeriod(this)">KaldÄ±r</button>
            </div>
          `;
      }
      pricePeriods.appendChild(row);
      // Sadece kullanÄ±cÄ± etkileÅŸimiyle eklendiÄŸinde veya ilk yÃ¼klemede hesapla
      if (!fromLoad) {
        calculateSavings(); 
      }
    }

    /**
     * Bir fiyat dÃ¶nemi giriÅŸ alanÄ±nÄ± kaldÄ±rÄ±r.
     * @param {HTMLElement} button - KaldÄ±r dÃ¼ÄŸmesi.
     */
    function removePeriod(button) {
      button.closest(".row").remove();
      calculateSavings(); // DÃ¶nem kaldÄ±rÄ±ldÄ±ÄŸÄ±nda tasarrufu yeniden hesapla
    }

    /**
     * Mevcut verileri localStorage'a kaydeder.
     */
    function saveData() {
        const dailyCigarettes = document.getElementById("dailyCigarettes").value;
        const startDate = startDateInput.value;
        // Sadece kullanÄ±cÄ± tarafÄ±ndan eklenen (tarihsel olmayan) dÃ¶nemleri kaydet
        const periods = Array.from(pricePeriods.children)
            .filter(row => !row.classList.contains("historical-period"))
            .map(row => {
                const date = row.querySelector(".period-date").value;
                const price = row.querySelector(".period-price").value;
                return { date, price };
            });

        const dataToSave = {
            dailyCigarettes: dailyCigarettes,
            startDate: startDate,
            periods: periods
        };
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
    }

    /**
     * localStorage'dan verileri yÃ¼kler.
     */
    function loadData() {
        const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
        
        // Ã–nce tÃ¼m fiyat dÃ¶nemlerini temizle
        while (pricePeriods.firstChild) {
            pricePeriods.removeChild(pricePeriods.firstChild);
        }
        
        // Her zaman varsayÄ±lan geÃ§miÅŸ verilerini ekle
        addDefaultHistoricalPeriods();

        if (savedData) {
            const data = JSON.parse(savedData);
            document.getElementById("dailyCigarettes").value = data.dailyCigarettes || 20;
            startDateInput.value = data.startDate;

            // KullanÄ±cÄ± tarafÄ±ndan kaydedilmiÅŸ dÃ¶nemleri ekle (bunlar tarihsel deÄŸil)
            if (data.periods && data.periods.length > 0) {
                data.periods.forEach(p => addPeriod(p.date, p.price, true, false)); // fromLoad=true, isHistorical=false
            }
        } else {
            // HiÃ§ kayÄ±tlÄ± veri yoksa, baÅŸlangÄ±Ã§ tarihini bugÃ¼ne ayarla
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            startDateInput.value = today.toISOString().split('T')[0];
        }
        calculateSavings(); // Veriler yÃ¼klendikten sonra hesaplamayÄ± tetikle
    }

    /**
     * VarsayÄ±lan geÃ§miÅŸ sigara fiyat dÃ¶nemlerini ekler.
     */
    function addDefaultHistoricalPeriods() {
        // Sigara fiyatlarÄ±na son 5 yÄ±lda yapÄ±lan zamlar ve fiyatlar (En ucuz paket baz alÄ±nmÄ±ÅŸtÄ±r)
        // Bu veriler yaklaÅŸÄ±k deÄŸerlerdir ve piyasadaki en ucuz sigara gruplarÄ± baz alÄ±nmÄ±ÅŸtÄ±r.
        // isHistorical parametresi true olarak ayarlandÄ±.
        addPeriod('2020-07-01', 20.00, true, true); 
        addPeriod('2021-01-01', 35.00, true, true);
        addPeriod('2022-01-01', 45.00, true, true);
        addPeriod('2023-06-05', 55.00, true, true); 
        addPeriod('2024-01-01', 65.00, true, true); 
        addPeriod('2025-03-05', 76.00, true, true); 
        addPeriod('2025-07-01', 90.00, true, true); // En gÃ¼ncel fiyatÄ± en sona ekleyin
    }


    /**
     * Sigara tasarrufunu hesaplar ve sonuÃ§larÄ± gÃ¼nceller.
     */
    function calculateSavings() {
      const dailyCigarettes = parseFloat(document.getElementById("dailyCigarettes").value);
      const quitDate = new Date(startDateInput.value);
      quitDate.setHours(0, 0, 0, 0); // Tarihin saatini sÄ±fÄ±rla, sadece gÃ¼nÃ¼ dikkate al

      // Gerekli giriÅŸlerin kontrolÃ¼
      if (!startDateInput.value || isNaN(dailyCigarettes) || dailyCigarettes <= 0) {
        resultDiv.innerHTML = '';
        detailedSavingsDiv.innerHTML = '';
        saveData(); // GeÃ§ersiz durumda da kaydet
        return;
      }

      const now = new Date();
      now.setHours(0, 0, 0, 0); // Tarihin saatini sÄ±fÄ±rla

      // BÄ±rakma tarihinin bugÃ¼nden ileri olmamasÄ± kontrolÃ¼
      if (now < quitDate) {
        resultDiv.innerHTML = 'BÄ±rakma tarihi bugÃ¼nden ileri bir tarih olamaz.';
        detailedSavingsDiv.innerHTML = '';
        saveData(); // GeÃ§ersiz durumda da kaydet
        return;
      }

      // Fiyat dÃ¶nemlerini al ve filtrele
      // Hem tarihsel hem de kullanÄ±cÄ± tarafÄ±ndan eklenen dÃ¶nemleri al
      const periods = Array.from(pricePeriods.children).map(row => {
        let date, price;
        if (row.classList.contains("historical-period")) {
            // Tarihsel dÃ¶nemler iÃ§in metin iÃ§eriÄŸini al
            // p etiketlerini doÄŸru div kapsayÄ±cÄ±larÄ± iÃ§inden seÃ§iyoruz
            date = new Date(row.querySelector(".col-md-5:nth-child(1) p").textContent);
            price = parseFloat(row.querySelector(".col-md-5:nth-child(2) p").textContent);
        } else {
            // KullanÄ±cÄ± eklediÄŸi dÃ¶nemler iÃ§in input deÄŸerlerini al
            date = new Date(row.querySelector(".period-date").value);
            price = parseFloat(row.querySelector(".period-price").value);
        }
        date.setHours(0, 0, 0, 0); // Tarihin saatini sÄ±fÄ±rla
        return { date, price };
      }).filter(p => !isNaN(p.date.getTime()) && !isNaN(p.price) && p.price > 0); // GeÃ§ersiz veya sÄ±fÄ±r/negatif fiyatlÄ± dÃ¶nemleri filtrele

      // Fiyat dÃ¶nemi yoksa uyarÄ± ver
      if (periods.length === 0) {
        resultDiv.innerHTML = 'En az bir geÃ§erli fiyat dÃ¶nemi ekleyiniz.';
        detailedSavingsDiv.innerHTML = '';
        saveData(); // GeÃ§ersiz durumda da kaydet
        return;
      }

      // Fiyat dÃ¶nemlerini tarihe gÃ¶re sÄ±rala (eskiden yeniye)
      periods.sort((a, b) => a.date.getTime() - b.date.getTime());

      let totalSavings = 0;
      let savingsDetailsHtml = '<h5>DÃ¶nemlere GÃ¶re Tasarruf DetaylarÄ±:</h5>';
      let periodSavings = {}; // Her dÃ¶nem iÃ§in tasarrufu tutacak obje

      // BÄ±rakma tarihinden itibaren bugÃ¼ne kadar her gÃ¼nÃ¼ dÃ¶ngÃ¼ye al
      let currentDate = new Date(quitDate);

      while (currentDate <= now) {
        let applicablePrice = 0;
        let currentPeriodStartDate = null;

        // Mevcut gÃ¼n iÃ§in geÃ§erli olan sigara paket fiyatÄ±nÄ± bul
        for (let i = 0; i < periods.length; i++) {
          if (currentDate >= periods[i].date) {
            applicablePrice = periods[i].price;
            currentPeriodStartDate = periods[i].date;
          } else {
            // EÄŸer mevcut gÃ¼n, bu dÃ¶nemin baÅŸlangÄ±Ã§ tarihinden kÃ¼Ã§Ã¼kse,
            // Ã¶nceki dÃ¶nemdeki fiyat geÃ§erlidir. DÃ¶ngÃ¼yÃ¼ kÄ±r.
            break;
          }
        }

        // GeÃ§erli bir fiyat varsa hesaplamaya dahil et
        if (applicablePrice > 0) {
            const dailyCost = (dailyCigarettes / 20) * applicablePrice; // GÃ¼nlÃ¼k sigara maliyeti (1 paket = 20 sigara)
            totalSavings += dailyCost;

            // DÃ¶nem bazÄ±nda tasarrufu topla
            // DÃ¶nem anahtarÄ±: "YYYY-MM-DD - Fiyatâ‚º"
            const periodKey = currentPeriodStartDate.toISOString().split('T')[0] + " - " + applicablePrice.toFixed(2) + "â‚º";
            if (!periodSavings[periodKey]) {
                periodSavings[periodKey] = 0;
            }
            periodSavings[periodKey] += dailyCost;
        }

        currentDate.setDate(currentDate.getDate() + 1); // Sonraki gÃ¼ne geÃ§
      }

      // DetaylÄ± tasarruf bilgilerini HTML'e ekle
      for (const key in periodSavings) {
          const [periodDateStr, priceStr] = key.split(' - ');
          const periodDate = new Date(periodDateStr);
          const formattedPeriodDate = periodDate.toLocaleDateString('tr-TR', { year: 'numeric', month: 'long', day: 'numeric' });
          savingsDetailsHtml += `<p class="period-savings-detail"><strong>${formattedPeriodDate}</strong> (${priceStr} paket fiyatÄ±): ${periodSavings[key].toFixed(2)} â‚º</p>`;
      }

      // SonuÃ§larÄ± ekrana yazdÄ±r
      resultDiv.innerHTML = `ğŸ’° Tahmini Toplam Tasarruf: <span class="text-dark">${totalSavings.toFixed(2)} â‚º</span>`;
      detailedSavingsDiv.innerHTML = savingsDetailsHtml;
      saveData(); // Hesaplama yapÄ±ldÄ±ktan sonra verileri kaydet
    }

    // Formdaki herhangi bir giriÅŸ deÄŸiÅŸtiÄŸinde hesaplamayÄ± tetikle
    document.getElementById("savingsForm").addEventListener("input", calculateSavings);

    // Sayfa yÃ¼klendiÄŸinde baÅŸlangÄ±Ã§ deÄŸerlerini ayarla ve ilk hesaplamayÄ± yap
    document.addEventListener("DOMContentLoaded", () => {
      loadData(); // localStorage'dan verileri yÃ¼kle
    });
  </script>
</body>
</html>
