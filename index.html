<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sigara Tasarruf HesaplayÄ±cÄ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8f9fa;
      padding: 2rem;
      display: flex; /* Ä°Ã§eriÄŸi dikeyde ve yatayda ortalamak iÃ§in */
      justify-content: center; /* Yatayda ortala */
      align-items: flex-start; /* Dikeyde baÅŸlangÄ±ca hizala, gerekirse ortala */
      min-height: 100vh; /* SayfanÄ±n tÃ¼m yÃ¼ksekliÄŸini kapla */
    }
    .container {
      max-width: 600px; /* Konteynerin maksimum geniÅŸliÄŸini ayarla */
      width: 100%; /* DuyarlÄ±lÄ±k iÃ§in geniÅŸliÄŸi %100 yap */
    }
    .card {
      box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
    }
    .remove-btn {
      cursor: pointer;
    }
    .form-control-sm {
      font-size: 0.9rem;
    }
    .period-inputs .row {
      margin-bottom: 0.5rem;
    }
    .result-box {
      font-weight: bold;
      font-size: 1.2rem;
      margin-top: 1rem;
    }
    /* .period-savings-detail sÄ±nÄ±fÄ± artÄ±k tablo satÄ±rlarÄ± iÃ§in kullanÄ±lacak, stilini gÃ¼ncelleyelim */
    .period-savings-detail td {
      font-size: 0.9rem;
      color: #555;
      padding: 0.25rem 0.5rem; /* HÃ¼cre iÃ§ boÅŸluklarÄ± */
    }
    .period-savings-table th {
        font-size: 0.95rem;
        padding: 0.5rem;
        background-color: #e9ecef;
        border-bottom: 2px solid #dee2e6;
    }
    .period-savings-table td {
        border-bottom: 1px solid #e9ecef;
    }
    .period-savings-table tbody tr:last-child td {
        border-bottom: none;
    }
    .period-savings-table tfoot td {
        font-weight: bold;
        padding-top: 0.75rem;
        border-top: 2px solid #dee2e6;
    }

    /* Tarih ve fiyat metinlerini input gibi hizalamak iÃ§in */
    .form-control-plaintext.form-control-sm {
        padding-top: calc(0.25rem + 1px);
        padding-bottom: calc(0.25rem + 1px);
        margin-bottom: 0;
        line-height: 1.5;
        border-bottom: 1px solid #dee2e6; /* Alt Ã§izgi ekleyelim */
    }
    /* Tarihsel dÃ¶nemler iÃ§in label'larÄ± gizle */
    .historical-period .form-label {
        display: none; /* Etiketleri gizle */
    }
    /* KullanÄ±cÄ± eklediÄŸi dÃ¶nemler iÃ§in label'larÄ± gizle */
    .period-inputs .col-5 label {
        display: none; /* Dinamik olarak eklenen dÃ¶nemlerin etiketlerini gizle */
    }
    /* Fiyat DÃ¶nemleri detaylarÄ±nÄ± baÅŸlangÄ±Ã§ta gizlemek iÃ§in */
    #historicalPeriodsContainer {
        display: none; /* BaÅŸlangÄ±Ã§ta gizli */
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card p-4">
      <h2 class="mb-4 text-center">ğŸš­ Sigara Tasarruf HesaplayÄ±cÄ±</h2>
      <form id="savingsForm">
        <div class="mb-3 row justify-content-center">
          <div class="col-md-5">
            <label for="dailyCigarettes" class="form-label">GÃ¼nlÃ¼k Sigara Adedi</label>
            <input type="number" class="form-control" id="dailyCigarettes" required>
          </div>
          <div class="col-md-5">
            <label for="startDate" class="form-label">BÄ±rakma Tarihi</label>
            <input type="date" class="form-control" id="startDate" required>
          </div>
        </div>

        <div class="d-flex align-items-center mt-4">
            <h5 class="mb-0">ğŸ“… Fiyat DÃ¶nemleri</h5>
            <button type="button" class="btn btn-sm btn-outline-info ms-auto" id="toggleHistoricalPeriodsBtn">GeÃ§miÅŸ FiyatlarÄ± GÃ¶ster</button>
        </div>
        
        <div id="historicalPeriodsContainer"> <!-- GeÃ§miÅŸ fiyatlarÄ±n kapsayÄ±cÄ±sÄ± -->
            <p class="text-muted small mb-3 mt-2">
              GeÃ§miÅŸ fiyat verileri piyasadaki ortalama en ucuz sigara paket fiyatlarÄ±na gÃ¶re eklenmiÅŸtir ve deÄŸiÅŸtirilemez.
              Yeni dÃ¶nemler ekleyerek kendi verilerinizi girebilirsiniz.
            </p>
            
            <div id="pricePeriodsTable" class="mb-3"> <!-- Yeni konteyner: BaÅŸlÄ±k ve dÃ¶nemleri iÃ§erir -->
                <div class="row fw-bold border-bottom pb-2 mb-2"> <!-- BaÅŸlÄ±k satÄ±rÄ± -->
                    <div class="col-5">BaÅŸlangÄ±Ã§ Tarihi</div>
                    <div class="col-5">Paket FiyatÄ± (â‚º)</div>
                    <div class="col-2 text-end"></div> <!-- KaldÄ±r butonu sÃ¼tunu iÃ§in boÅŸluk -->
                </div>
                <div id="pricePeriods" class="period-inputs"></div> <!-- DÃ¶nemlerin ekleneceÄŸi yer -->
            </div>
        </div>

        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addPeriod()">+ DÃ¶nem Ekle</button>

        <h5 class="mt-3">DÃ¶nemlere GÃ¶re Tasarruf DetaylarÄ±:</h5>
        <div id="detailedSavings" class="mt-2"></div>
      </form>
    </div>
  </div>

  <script>
    const pricePeriods = document.getElementById("pricePeriods");
    const startDateInput = document.getElementById("startDate");
    const resultDiv = document.getElementById("result");
    const detailedSavingsDiv = document.getElementById("detailedSavings");
    const historicalPeriodsContainer = document.getElementById("historicalPeriodsContainer");
    const toggleHistoricalPeriodsBtn = document.getElementById("toggleHistoricalPeriodsBtn");

    const LOCAL_STORAGE_KEY = 'cigaretteSavingsData';

    /**
     * YYYY-MM-DD formatÄ±ndaki bir tarih dizesini gg.aa.yyyy formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
     * @param {string} dateString - YYYY-MM-DD formatÄ±nda tarih dizesi.
     * @returns {string} gg.aa.yyyy formatÄ±nda tarih dizesi.
     */
    function formatDateToDDMMYYYY(dateString) {
        if (!dateString) return '';
        const [year, month, day] = dateString.split('-');
        return `${day}.${month}.${year}`;
    }

    /**
     * gg.aa.yyyy formatÄ±ndaki bir tarih dizesini YYYY-MM-DD formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
     * @param {string} dateString - gg.aa.yyyy formatÄ±nda tarih dizesi.
     * @returns {string} YYYY-MM-DD formatÄ±nda tarih dizesi.
     */
    function parseDateFromDDMMYYYY(dateString) {
        if (!dateString) return '';
        const parts = dateString.split('.');
        if (parts.length === 3) {
            return `${parts[2]}-${parts[1]}-${parts[0]}`; // YYYY-MM-DD
        }
        return ''; // GeÃ§ersiz format
    }

    /**
     * Yeni bir fiyat dÃ¶nemi giriÅŸ alanÄ± ekler.
     * @param {string} date - DÃ¶nemin baÅŸlangÄ±Ã§ tarihi (YYYY-MM-DD formatÄ±nda).
     * @param {number} price - Paket fiyatÄ±.
     * @param {boolean} fromLoad - Verinin localStorage'dan mÄ± yÃ¼klendiÄŸini belirtir.
     * @param {boolean} isHistorical - DÃ¶nemin sabit geÃ§miÅŸ veri olup olmadÄ±ÄŸÄ±nÄ± belirtir.
     */
    function addPeriod(date = '', price = '', fromLoad = false, isHistorical = false) {
      const row = document.createElement("div");
      row.classList.add("row", "align-items-end");
      
      const displayDate = formatDateToDDMMYYYY(date); // Tarihi gg.aa.yyyy formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼r

      if (isHistorical) {
          row.classList.add("historical-period"); // Tarihsel dÃ¶nemleri iÅŸaretlemek iÃ§in sÄ±nÄ±f
          row.innerHTML = `
            <div class="col-5">
              <p class="form-control-plaintext form-control-sm">${displayDate}</p>
            </div>
            <div class="col-5">
              <p class="form-control-plaintext form-control-sm">${price.toFixed(2)} â‚º</p>
            </div>
            <div class="col-2 text-end">
              <!-- Tarihsel veriler iÃ§in kaldÄ±r butonu yok -->
            </div>
          `;
      } else {
          row.innerHTML = `
            <div class="col-5">
              <input type="date" class="form-control form-control-sm period-date" value="${date}">
            </div>
            <div class="col-5">
              <input type="number" class="form-control form-control-sm period-price" step="0.01" value="${price}">
            </div>
            <div class="col-2 text-end">
              <button type="button" class="btn btn-sm btn-outline-danger remove-btn" onclick="removePeriod(this)">KaldÄ±r</button>
            </div>
          `;
      }
      pricePeriods.appendChild(row);
      if (!fromLoad) {
        calculateSavings(); 
      }
    }

    /**
     * Bir fiyat dÃ¶nemi giriÅŸ alanÄ±nÄ± kaldÄ±rÄ±r.
     * @param {HTMLElement} button - KaldÄ±r dÃ¼ÄŸmesi.
     */
    function removePeriod(button) {
      button.closest(".row").remove();
      calculateSavings();
    }

    /**
     * Mevcut verileri localStorage'a kaydeder.
     */
    function saveData() {
        const dailyCigarettes = document.getElementById("dailyCigarettes").value;
        const startDate = startDateInput.value;
        const periods = Array.from(pricePeriods.children)
            .filter(row => !row.classList.contains("historical-period"))
            .map(row => {
                const date = row.querySelector(".period-date").value;
                const price = row.querySelector(".period-price").value;
                return { date, price };
            });

        const dataToSave = {
            dailyCigarettes: dailyCigarettes,
            startDate: startDate,
            periods: periods
        };
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
    }

    /**
     * localStorage'dan verileri yÃ¼kler.
     */
    function loadData() {
        // TÃ¼m mevcut dÃ¶nemleri temizle
        while (pricePeriods.firstChild) {
            pricePeriods.removeChild(pricePeriods.firstChild);
        }
        
        // Her zaman varsayÄ±lan geÃ§miÅŸ verilerini ekle
        addDefaultHistoricalPeriods();

        const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (savedData) {
            const data = JSON.parse(savedData);
            document.getElementById("dailyCigarettes").value = data.dailyCigarettes || '';
            startDateInput.value = data.startDate || '';

            if (data.periods && data.periods.length > 0) {
                data.periods.forEach(p => addPeriod(p.date, p.price, true, false));
            }
        } else {
            document.getElementById("dailyCigarettes").value = '';
            startDateInput.value = '';
        }

        // loadData tamamlandÄ±ktan sonra hesaplamayÄ± tetikle
        calculateSavings();
    }

    /**
     * VarsayÄ±lan geÃ§miÅŸ sigara fiyat dÃ¶nemlerini ekler.
     */
    function addDefaultHistoricalPeriods() {
        addPeriod('2019-01-01', 11.00, true, true); 
        addPeriod('2020-01-01', 16.00, true, true);
        addPeriod('2021-01-01', 16.00, true, true);
        addPeriod('2022-01-01', 23.00, true, true);
        addPeriod('2022-04-01', 25.00, true, true);
        addPeriod('2023-01-01', 34.00, true, true);
        addPeriod('2023-07-01', 45.00, true, true);
        addPeriod('2023-09-05', 51.00, true, true);
        addPeriod('2024-01-01', 56.00, true, true);
        addPeriod('2024-07-01', 70.00, true, true);
        addPeriod('2024-10-01', 81.00, true, true);
        addPeriod('2025-03-01', 76.00, true, true);
        addPeriod('2025-07-01', 91.00, true, true);
    }

    /**
     * Sigara tasarrufunu hesaplar ve sonuÃ§larÄ± gÃ¼nceller.
     */
    function calculateSavings() {
      const dailyCigarettes = parseFloat(document.getElementById("dailyCigarettes").value);
      const quitDate = new Date(startDateInput.value);
      quitDate.setHours(0, 0, 0, 0);

      // Debug log: GiriÅŸ deÄŸerlerini kontrol et
      console.log("calculateSavings triggered. Daily Cigarettes:", dailyCigarettes, "Quit Date String:", startDateInput.value);

      // Gerekli giriÅŸlerin kontrolÃ¼
      if (!startDateInput.value || isNaN(dailyCigarettes) || dailyCigarettes <= 0) {
        if (resultDiv) resultDiv.innerHTML = '';
        if (detailedSavingsDiv) detailedSavingsDiv.innerHTML = '';
        saveData();
        console.log("Invalid input (empty date/cigarettes or non-positive), clearing results.");
        return;
      }
      console.log("Input is valid. Proceeding with calculation.");

      const now = new Date();
      now.setHours(0, 0, 0, 0);

      if (now < quitDate) {
        if (resultDiv) resultDiv.innerHTML = 'BÄ±rakma tarihi bugÃ¼nden ileri bir tarih olamaz.';
        if (detailedSavingsDiv) detailedSavingsDiv.innerHTML = '';
        saveData();
        console.log("Quit date is in the future, clearing results.");
        return;
      }

      const periods = Array.from(pricePeriods.children).map(row => {
        let date, price;
        if (row.classList.contains("historical-period")) {
            const dateP = row.querySelector(".col-5:nth-child(1) p");
            const priceP = row.querySelector(".col-5:nth-child(2) p");
            if (dateP && priceP) {
                const parsedDateString = parseDateFromDDMMYYYY(dateP.textContent);
                date = new Date(parsedDateString);
                price = parseFloat(priceP.textContent.replace(' â‚º', '')); 
                console.log(`Historical Period: Display Date: ${dateP.textContent}, Parsed Date String: ${parsedDateString}, Date Object: ${date}, Price: ${price}`);
            } else {
                console.error("Tarihsel dÃ¶nem satÄ±rÄ±nda beklenen <p> elementleri eksik:", row);
                return { date: new Date('Invalid Date'), price: 0 };
            }
        } else {
            const dateInput = row.querySelector(".period-date");
            const priceInput = row.querySelector(".period-price");
            if (dateInput && priceInput) {
                date = new Date(dateInput.value);
                price = parseFloat(priceInput.value);
                console.log(`User Period: Date Input: ${dateInput.value}, Date Object: ${date}, Price: ${price}`);
            } else {
                console.error("KullanÄ±cÄ± tarafÄ±ndan eklenen dÃ¶nem satÄ±rÄ±nda beklenen input elementleri eksik:", row);
                return { date: new Date('Invalid Date'), price: 0 };
            }
        }
        date.setHours(0, 0, 0, 0);
        return { date, price };
      }).filter(p => {
          const isValid = !isNaN(p.date.getTime()) && !isNaN(p.price) && p.price > 0;
          console.log(`Period after map and before filter: Date: ${p.date}, Price: ${p.price}, Is Valid: ${isValid}`);
          return isValid;
      });

      console.log("Periods after filtering:", periods); // Debug log

      if (periods.length === 0) {
        if (resultDiv) resultDiv.innerHTML = 'En az bir geÃ§erli fiyat dÃ¶nemi ekleyiniz.';
        if (detailedSavingsDiv) detailedSavingsDiv.innerHTML = '';
        saveData();
        console.log("No valid periods found after filtering, clearing results.");
        return;
      }

      periods.sort((a, b) => a.date.getTime() - b.date.getTime());

      let totalSavings = 0;
      let savingsDetails = []; // DetaylarÄ± tutacak dizi
      let periodAccumulatedSavings = {}; // Her dÃ¶nem iÃ§in biriken tasarrufu tutacak obje

      let currentDate = new Date(quitDate);

      while (currentDate <= now) {
        let applicablePrice = 0;
        let currentPeriodStartDate = null;

        for (let i = 0; i < periods.length; i++) {
          if (currentDate >= periods[i].date) {
            applicablePrice = periods[i].price;
            currentPeriodStartDate = periods[i].date;
          } else {
            break;
          }
        }

        if (applicablePrice > 0) {
            const dailyCost = (dailyCigarettes / 20) * applicablePrice;
            totalSavings += dailyCost;

            const periodKey = currentPeriodStartDate.toISOString().split('T')[0]; // Sadece tarih bazÄ±nda anahtar
            if (!periodAccumulatedSavings[periodKey]) {
                periodAccumulatedSavings[periodKey] = {
                    amount: 0,
                    price: applicablePrice,
                    startDate: currentPeriodStartDate // Bu, dÃ¶nemin gerÃ§ek baÅŸlangÄ±Ã§ tarihi
                };
            }
            periodAccumulatedSavings[periodKey].amount += dailyCost;
        }

        currentDate.setDate(currentDate.getDate() + 1);
      }

      // DetaylarÄ± tablo formatÄ±nda oluÅŸtur
      let tableHtml = `
        <table class="table table-sm period-savings-table">
            <thead>
                <tr>
                    <th>DÃ¶nem BaÅŸlangÄ±cÄ±</th>
                    <th>Paket FiyatÄ±</th>
                    <th class="text-end">Tasarruf (â‚º)</th>
                </tr>
            </thead>
            <tbody>
      `;
      
      const sortedPeriodKeys = Object.keys(periodAccumulatedSavings).sort(); // Tarih sÄ±rasÄ±na gÃ¶re sÄ±rala

      for (const key of sortedPeriodKeys) {
          const periodData = periodAccumulatedSavings[key];
          const periodStartDate = new Date(key); // DÃ¶nemin gerÃ§ek baÅŸlangÄ±Ã§ tarihi
          
          // EÄŸer bÄ±rakma tarihi bu dÃ¶nemin baÅŸlangÄ±cÄ±ndan sonraysa,
          // o dÃ¶nemin baÅŸlangÄ±cÄ±nÄ± bÄ±rakma tarihi olarak kabul et
          let displayStartDate = periodStartDate;
          if (periodStartDate < quitDate) {
              displayStartDate = quitDate;
          }

          tableHtml += `
              <tr>
                  <td>${formatDateToDDMMYYYY(displayStartDate.toISOString().split('T')[0])}</td>
                  <td>${periodData.price.toFixed(2)} â‚º</td>
                  <td class="text-end">${periodData.amount.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚º</td>
              </tr>
          `;
      }

      tableHtml += `
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="2">Toplam Tasarruf</td>
                    <td class="text-end">${totalSavings.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚º</td>
                </tr>
            </tfoot>
        </table>
      `;

      // SonuÃ§larÄ± ekrana yazdÄ±r
      if (resultDiv) resultDiv.innerHTML = `ğŸ’° Tahmini Toplam Tasarruf: <span class="text-dark">${totalSavings.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚º</span>`;
      if (detailedSavingsDiv) detailedSavingsDiv.innerHTML = tableHtml; // Tablo HTML'ini atÄ±yoruz
      saveData();
      console.log("Calculations completed and results rendered.");
    }

    // GeÃ§miÅŸ fiyatlarÄ± gÃ¶ster/gizle dÃ¼ÄŸmesi iÅŸlevi
    toggleHistoricalPeriodsBtn.addEventListener('click', () => {
        if (historicalPeriodsContainer.style.display === 'none' || historicalPeriodsContainer.style.display === '') {
            historicalPeriodsContainer.style.display = 'block';
            toggleHistoricalPeriodsBtn.textContent = 'GeÃ§miÅŸ FiyatlarÄ± Gizle';
        } else {
            historicalPeriodsContainer.style.display = 'none';
            toggleHistoricalPeriodsBtn.textContent = 'GeÃ§miÅŸ FiyatlarÄ± GÃ¶ster';
        }
    });

    document.getElementById("savingsForm").addEventListener("input", calculateSavings);

    document.addEventListener("DOMContentLoaded", () => {
      loadData();
    });
  </script>
</body>
</html>
